---
interface Props {
  defaultLang?: 'en' | 'zh' | 'both';
}
const { defaultLang = 'both' } = Astro.props;
---
<div class="bilingual-content" data-default-lang={defaultLang}>
  <div class="lang-toggle">
    <button class="lang-btn" data-lang="both">Both</button>
    <button class="lang-btn" data-lang="en">English</button>
    <button class="lang-btn" data-lang="zh">中文</button>
  </div>
  <div class="content-wrapper">
    <slot />
  </div>
</div>

<style>
.bilingual-content {
  margin: 1.5rem 0;
}
.lang-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: 8px;
  width: fit-content;
}
.lang-btn {
  padding: 0.5rem 1.25rem;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  font-weight: 500;
}
.lang-btn:hover {
  background: var(--bg);
  color: var(--text);
}
.lang-btn.active {
  background: var(--primary);
  color: white;
  box-shadow: 0 2px 4px rgba(83, 165, 81, 0.3);
}
.content-wrapper {
  display: block;
}
.content-wrapper.side-by-side {
  display: grid;
  grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
  gap: 2.5rem;
}
.content-wrapper.side-by-side > .lang-en,
.content-wrapper.side-by-side > .lang-zh {
  overflow-x: auto;
  min-width: 0;
}
/* Elements outside language containers span full width */
.content-wrapper.side-by-side > :not(.lang-en):not(.lang-zh) {
  grid-column: 1 / -1;
}
.content-wrapper.side-by-side > .lang-en,
.content-wrapper.side-by-side > .lang-zh {
  border-left: 3px solid var(--primary);
  padding-left: 1.25rem;
}
.content-wrapper.side-by-side > .lang-en {
  border-color: var(--primary);
}
.content-wrapper.side-by-side > .lang-zh {
  border-color: var(--primary-light);
}
/* Single-language content: span full width in both mode */
.content-wrapper.side-by-side:not(:has(.lang-en)) > .lang-zh,
.content-wrapper.side-by-side:not(:has(.lang-zh)) > .lang-en {
  grid-column: 1 / -1;
  border-left: none;
  padding-left: 0;
}
@media (max-width: 900px) {
  .content-wrapper.side-by-side {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.bilingual-content').forEach(container => {
    const buttons = container.querySelectorAll('.lang-btn');
    const wrapper = container.querySelector('.content-wrapper');
    const defaultLang = container.dataset.defaultLang || 'both';

    const toggle = container.querySelector('.lang-toggle');

    // Auto-detect if content is bilingual
    const hasEn = wrapper?.querySelector('.lang-en');
    const hasZh = wrapper?.querySelector('.lang-zh');
    const isBilingual = hasEn && hasZh;

    // Hide toggle for single-language content
    if (!isBilingual && toggle) {
      toggle.style.display = 'none';
      // Show whichever language exists, no side-by-side needed
      if (hasZh) {
        hasZh.style.display = '';
        wrapper?.classList.remove('side-by-side');
      }
      if (hasEn) {
        hasEn.style.display = '';
        wrapper?.classList.remove('side-by-side');
      }
      return;
    }

    // Get saved preference or use default
    const savedLang = localStorage.getItem('preferred-lang') || defaultLang;

    function setLanguage(lang) {
      // Update button states
      buttons.forEach(b => {
        b.classList.toggle('active', b.dataset.lang === lang);
      });

      // Update content visibility
      const enContent = wrapper?.querySelectorAll('.lang-en');
      const zhContent = wrapper?.querySelectorAll('.lang-zh');

      if (lang === 'both') {
        enContent?.forEach(el => el.style.display = '');
        zhContent?.forEach(el => el.style.display = '');
        wrapper?.classList.add('side-by-side');
      } else if (lang === 'en') {
        enContent?.forEach(el => el.style.display = '');
        zhContent?.forEach(el => el.style.display = 'none');
        wrapper?.classList.remove('side-by-side');
      } else if (lang === 'zh') {
        enContent?.forEach(el => el.style.display = 'none');
        zhContent?.forEach(el => el.style.display = '');
        wrapper?.classList.remove('side-by-side');
      }

      // Save preference
      localStorage.setItem('preferred-lang', lang);
    }

    // Set initial state
    setLanguage(savedLang);

    // Add click handlers
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        setLanguage(btn.dataset.lang);
      });
    });
  });
});
</script>
