---
import QRCode from 'qrcode';

interface Props {
  url: string;
  title: string;
}

const { url, title } = Astro.props;
const encodedURL = encodeURIComponent(url);
const encodedTitle = encodeURIComponent(title);

let qrSvg = '';
try {
  qrSvg = await QRCode.toString(url, { type: 'svg', width: 200, margin: 2 });
} catch {}

const shareLinks = [
  { name: 'X', href: `https://x.com/intent/tweet?url=${encodedURL}&text=${encodedTitle}`, icon: 'M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z' },
  { name: 'LinkedIn', href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedURL}`, icon: 'M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z' },
  { name: 'Facebook', href: `https://www.facebook.com/sharer/sharer.php?u=${encodedURL}`, icon: 'M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z' },
  { name: 'Reddit', href: `https://reddit.com/submit?url=${encodedURL}&title=${encodedTitle}`, icon: 'M12 0C5.373 0 0 5.373 0 12c0 6.627 5.373 12 12 12s12-5.373 12-12c0-6.627-5.373-12-12-12zm6.066 13.71c.147.307.222.64.222.986 0 2.126-2.48 3.854-5.53 3.854-3.05 0-5.532-1.728-5.532-3.854 0-.347.075-.68.223-.986a1.534 1.534 0 01-.223-.803c0-.852.692-1.544 1.544-1.544.424 0 .808.176 1.082.458a7.578 7.578 0 013.003-.627l.582-2.744.036-.009 1.9.405a1.09 1.09 0 011.07-.868c.604 0 1.093.49 1.093 1.093 0 .604-.49 1.093-1.093 1.093-.573 0-1.04-.44-1.088-1.002l-1.678-.358-.506 2.38a7.622 7.622 0 012.932.622 1.532 1.532 0 011.082-.458c.852 0 1.544.692 1.544 1.544 0 .296-.083.573-.223.803zM9.544 14.087c0 .604.49 1.093 1.093 1.093.604 0 1.093-.49 1.093-1.093 0-.604-.49-1.093-1.093-1.093-.604 0-1.093.49-1.093 1.093zm5.723 0c0 .604.49 1.093 1.093 1.093.604 0 1.093-.49 1.093-1.093 0-.604-.49-1.093-1.093-1.093-.604 0-1.093.49-1.093 1.093zm-4.46 3.167c.36.36 1.085.54 1.693.54.608 0 1.333-.18 1.693-.54a.274.274 0 01.387.387c-.467.467-1.333.653-2.08.653-.747 0-1.613-.186-2.08-.653a.274.274 0 01.387-.387z' },
  { name: 'Hacker News', href: `https://news.ycombinator.com/submitlink?u=${encodedURL}&t=${encodedTitle}`, icon: 'M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z' },
];
---

<div class="share-buttons">
  <span class="share-label">Share</span>
  {shareLinks.map(link => (
    <a href={link.href} target="_blank" rel="noopener noreferrer" aria-label={`Share on ${link.name}`} class="share-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d={link.icon}/></svg>
    </a>
  ))}
  <button class="share-btn wechat-btn" aria-label="Share on WeChat" type="button">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 01.213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 00.167-.054l1.903-1.114a.864.864 0 01.717-.098 10.16 10.16 0 002.837.403c.276 0 .543-.027.811-.05a6.127 6.127 0 01-.253-1.726c0-3.573 3.26-6.47 7.278-6.47.122 0 .243.005.364.014-.494-2.95-3.733-5.45-7.7-5.45zm-2.82 4.098a1.074 1.074 0 110 2.148 1.074 1.074 0 010-2.148zm5.34 0a1.074 1.074 0 110 2.148 1.074 1.074 0 010-2.148zM15.527 8.83c-3.583 0-6.527 2.57-6.527 5.735 0 3.166 2.944 5.735 6.527 5.735a7.89 7.89 0 002.2-.312.672.672 0 01.557.076l1.48.866a.253.253 0 00.13.042.227.227 0 00.224-.228c0-.056-.022-.11-.037-.165l-.303-1.152a.458.458 0 01.166-.517C21.633 17.96 22.054 16.1 22.054 14.565c0-3.166-2.944-5.735-6.527-5.735zm-2.158 3.292a.835.835 0 110 1.67.835.835 0 010-1.67zm4.316 0a.835.835 0 110 1.67.835.835 0 010-1.67z"/></svg>
  </button>
  <button class="share-btn copy-btn" aria-label="Copy link" data-url={url} type="button">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
  </button>
</div>

<!-- WeChat QR Modal -->
<div class="wechat-modal" role="dialog" aria-label="WeChat QR Code" aria-hidden="true">
  <div class="wechat-modal-content">
    <button class="wechat-modal-close" aria-label="Close" type="button">&times;</button>
    <p>Scan to share on WeChat</p>
    <div class="qr-code" set:html={qrSvg} />
  </div>
</div>

<style>
  .share-buttons {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 2rem 0;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }
  .share-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-right: 0.25rem;
  }
  .share-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-secondary);
    color: var(--text);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    padding: 0;
    font-size: inherit;
    line-height: 1;
  }
  .share-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  .wechat-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  .wechat-modal.active {
    display: flex;
  }
  .wechat-modal-content {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    position: relative;
    max-width: 280px;
  }
  .wechat-modal-content p {
    margin-bottom: 1rem;
    font-weight: 500;
    color: var(--text);
  }
  .wechat-modal-close {
    position: absolute;
    top: 0.5rem;
    right: 0.75rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    line-height: 1;
  }
  .qr-code :global(svg) {
    width: 200px;
    height: 200px;
  }
  .copy-btn.copied {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const modal = document.querySelector('.wechat-modal');
    const wechatBtn = document.querySelector('.wechat-btn');
    const closeBtn = document.querySelector('.wechat-modal-close');
    const copyBtn = document.querySelector('.copy-btn') as HTMLElement | null;

    wechatBtn?.addEventListener('click', () => {
      modal?.classList.add('active');
      modal?.setAttribute('aria-hidden', 'false');
    });

    const closeModal = () => {
      modal?.classList.remove('active');
      modal?.setAttribute('aria-hidden', 'true');
    };
    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    copyBtn?.addEventListener('click', () => {
      const url = copyBtn.dataset.url;
      if (!url) return;
      navigator.clipboard.writeText(url).then(() => {
        copyBtn.classList.add('copied');
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
        setTimeout(() => {
          copyBtn.classList.remove('copied');
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>';
        }, 2000);
      });
    });
  });
</script>
