---
import Layout from '../layouts/Layout.astro';
import seedApps from '../data/ai-apps.json';
---
<Layout title="Invitation Codes / 邀请码">
<div id="ic-page">
  <div class="auth-bar" id="auth-bar">
    <button class="btn-github" id="btn-login">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
      <span data-i18n="login">Sign in with GitHub</span>
    </button>
    <div class="user-info" id="user-info" style="display:none">
      <img id="user-avatar" class="avatar" width="28" height="28" alt="" />
      <span id="user-name"></span>
      <button class="btn-logout" id="btn-logout" data-i18n="logout">Logout</button>
    </div>
  </div>

  <h1>Invitation Codes / 邀请码</h1>
  <p class="subtitle" data-i18n="subtitle">Share and find invitation codes for AI apps</p>

  <div class="category-tabs" id="category-tabs">
    <button class="tab active" data-category="all" data-i18n="all">All</button>
    <button class="tab" data-category="assistant" data-i18n="assistant">AI Assistants</button>
    <button class="tab" data-category="coding" data-i18n="coding">Coding Tools</button>
    <button class="tab" data-category="search" data-i18n="search">AI Search</button>
  </div>

  <div class="app-grid" id="app-grid">
    {seedApps.map(app => (
      <button class="app-card" data-slug={app.slug} data-category={app.category} data-website={app.website}>
        <img src={app.icon} alt={app.name} class="app-icon" width="40" height="40" loading="lazy" />
        <span class="app-name">{app.name}</span>
        <span class="code-count" data-count-for={app.slug}>-</span>
      </button>
    ))}
  </div>

  <button class="btn-add-app" id="btn-add-app" style="display:none" data-i18n="addApp">+ Add App</button>
  <div class="add-app-form" id="add-app-form" style="display:none">
    <input type="text" id="app-name-input" maxlength="50" data-i18n-placeholder="appName" placeholder="App name" />
    <input type="url" id="app-website-input" maxlength="200" data-i18n-placeholder="appWebsite" placeholder="https://..." />
    <select id="app-category-input">
      <option value="assistant" data-i18n="assistant">AI Assistants</option>
      <option value="coding" data-i18n="coding">Coding Tools</option>
      <option value="search" data-i18n="search">AI Search</option>
    </select>
    <button class="btn-submit" id="btn-add-app-submit" data-i18n="submit">Submit</button>
    <button class="btn-cancel" id="btn-add-app-cancel" data-i18n="cancel">Cancel</button>
  </div>
  <div class="code-panel" id="code-panel" style="display:none">
    <div class="panel-header">
      <h2 id="panel-app-name"></h2>
      <a id="panel-app-link" target="_blank" rel="noopener noreferrer" class="app-link">
        <span data-i18n="visit">Visit</span> ↗
      </a>
    </div>
    <div id="code-list" class="code-list"></div>
    <div id="submit-form" class="submit-form" style="display:none">
      <input type="text" id="code-input" maxlength="100" data-i18n-placeholder="enterCode" placeholder="Enter invitation code..." />
      <button class="btn-submit" id="btn-submit" data-i18n="submit">Submit</button>
    </div>
    <p id="login-hint" class="login-hint" data-i18n="loginHint" style="display:none">Sign in with GitHub to submit codes</p>
  </div>
</div>
</Layout>

<style>
#ic-page { position: relative; }
.auth-bar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding: 1rem 0;
}
.btn-github {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: #24292e;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
}
.btn-github:hover { background: #444d56; }
.user-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.avatar { border-radius: 50%; }
.btn-logout {
  padding: 0.3rem 0.75rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  cursor: pointer;
  font-size: 0.85rem;
}
.btn-logout:hover { border-color: var(--primary); }
h1 { margin-bottom: 0.25rem; }
.subtitle {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}
.category-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}
.tab {
  padding: 0.4rem 1rem;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: var(--bg);
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}
.tab:hover { border-color: var(--primary); color: var(--primary); }
.tab.active {
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}
.app-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}
.app-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem 0.5rem;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg);
  cursor: pointer;
  transition: all 0.2s;
}
.app-card:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
}
.app-card.active {
  border-color: var(--primary);
  background: var(--bg-secondary);
  box-shadow: 0 0 0 2px var(--primary-light);
}
.app-card.hidden { display: none; }
.app-icon {
  border-radius: 8px;
  object-fit: contain;
}
.app-name {
  font-size: 0.85rem;
  font-weight: 500;
  text-align: center;
  color: var(--text);
}
.code-count {
  font-size: 0.75rem;
  color: var(--text-muted);
  background: var(--bg-secondary);
  padding: 0.1rem 0.5rem;
  border-radius: 10px;
}
.btn-add-app {
  display: block;
  margin-bottom: 1.5rem;
  padding: 0.4rem 1rem;
  border: 1px dashed var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--primary);
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}
.btn-add-app:hover { border-color: var(--primary); background: var(--bg-secondary); }
.add-app-form {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}
.add-app-form input, .add-app-form select {
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text);
  font-size: 0.9rem;
}
.add-app-form input:focus, .add-app-form select:focus {
  outline: none;
  border-color: var(--primary);
}
.add-app-form input[type="text"] { flex: 1; min-width: 120px; }
.add-app-form input[type="url"] { flex: 2; min-width: 180px; }
.btn-cancel {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.9rem;
}
.btn-cancel:hover { border-color: var(--primary); }
.code-panel {
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1.5rem;
  margin-bottom: 2rem;
}
.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}
.panel-header h2 { margin: 0; font-size: 1.25rem; }
.app-link { font-size: 0.85rem; text-decoration: none; }
.code-list { margin-bottom: 1rem; }
.code-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.6rem 0;
  border-bottom: 1px solid var(--border);
}
.code-item:last-child { border-bottom: none; }
.code-text {
  font-family: 'Fira Code', monospace;
  font-size: 0.95rem;
  background: var(--bg-secondary);
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  word-break: break-all;
}
.code-meta {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-left: auto;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.btn-copy, .btn-delete {
  padding: 0.3rem;
  border: none;
  border-radius: 4px;
  background: transparent;
  cursor: pointer;
  line-height: 0;
  transition: opacity 0.2s;
  display: inline-flex;
  align-items: center;
}
.btn-copy { color: var(--primary); }
.btn-copy:hover { opacity: 0.6; }
.btn-delete { color: #e55; }
.btn-delete:hover { opacity: 0.6; }
.submit-form {
  display: flex;
  gap: 0.5rem;
}
.submit-form input {
  flex: 1;
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text);
  font-size: 0.9rem;
}
.submit-form input:focus {
  outline: none;
  border-color: var(--primary);
}
.btn-submit {
  padding: 0.5rem 1.25rem;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
}
.btn-submit:hover { background: var(--primary-dark); }
.login-hint {
  color: var(--text-muted);
  font-size: 0.85rem;
  font-style: italic;
}
.empty-msg {
  color: var(--text-muted);
  font-size: 0.9rem;
  padding: 1rem 0;
}
@media (max-width: 640px) {
  .app-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
  .code-item { flex-wrap: wrap; }
  .code-meta { margin-left: 0; }
  .add-app-form { flex-direction: column; }
}
</style>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = 'https://agzseodrnmhdgfdbtusp.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_dBquGpwFjfNK2XFyZfBeXw_UMoZgC38';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const i18n = {
  en: {
    login: 'Sign in with GitHub', logout: 'Logout',
    subtitle: 'Share and find invitation codes for AI apps',
    all: 'All', assistant: 'AI Assistants', coding: 'Coding Tools', search: 'AI Search',
    visit: 'Visit', submit: 'Submit', enterCode: 'Enter invitation code...',
    loginHint: 'Sign in with GitHub to submit codes',
    copied: 'Copied!', copy: 'Copy', delete: 'Delete', cancel: 'Cancel',
    noCodes: 'No codes yet. Be the first to share one!',
    addApp: '+ Add App', appName: 'App name', appWebsite: 'https://...',
    ago: { s: 's ago', m: 'm ago', h: 'h ago', d: 'd ago' }
  },
  zh: {
    login: 'GitHub 登录', logout: '退出',
    subtitle: '分享和查找 AI 应用的邀请码',
    all: '全部', assistant: 'AI 助手', coding: '编程工具', search: 'AI 搜索',
    visit: '访问', submit: '提交', enterCode: '输入邀请码...',
    loginHint: '请先登录 GitHub 以提交邀请码',
    copied: '已复制!', copy: '复制', delete: '删除', cancel: '取消',
    noCodes: '暂无邀请码，来分享第一个吧！',
    addApp: '+ 添加应用', appName: '应用名称', appWebsite: 'https://...',
    ago: { s: '秒前', m: '分钟前', h: '小时前', d: '天前' }
  }
};

const lang = localStorage.getItem('preferred-lang') === 'zh' ? 'zh' : 'en';
const t = (key) => i18n[lang]?.[key] || i18n.en[key] || key;

function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.dataset.i18nPlaceholder);
  });
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function timeAgo(dateStr) {
  const diff = (Date.now() - new Date(dateStr).getTime()) / 1000;
  const a = t('ago');
  if (diff < 60) return Math.floor(diff) + a.s;
  if (diff < 3600) return Math.floor(diff / 60) + a.m;
  if (diff < 86400) return Math.floor(diff / 3600) + a.h;
  return Math.floor(diff / 86400) + a.d;
}

let currentUser = null;
let selectedApp = null;
let allApps = []; // merged seed + user-submitted

// Auth
const { data: { session } } = await supabase.auth.getSession();
if (session) setUser(session.user);
supabase.auth.onAuthStateChange((_event, session) => {
  setUser(session?.user || null);
});

function setUser(user) {
  currentUser = user;
  const loginBtn = document.getElementById('btn-login');
  const userInfo = document.getElementById('user-info');
  const addAppBtn = document.getElementById('btn-add-app');
  if (user) {
    loginBtn.style.display = 'none';
    userInfo.style.display = 'flex';
    const meta = user.user_metadata;
    document.getElementById('user-avatar').src = meta.avatar_url || '';
    document.getElementById('user-name').textContent = '@' + (meta.user_name || meta.preferred_username || '');
    document.getElementById('submit-form').style.display = selectedApp ? 'flex' : 'none';
    document.getElementById('login-hint').style.display = 'none';
    addAppBtn.style.display = 'block';
  } else {
    loginBtn.style.display = 'flex';
    userInfo.style.display = 'none';
    document.getElementById('submit-form').style.display = 'none';
    if (selectedApp) document.getElementById('login-hint').style.display = 'block';
    addAppBtn.style.display = 'none';
    document.getElementById('add-app-form').style.display = 'none';
  }
}

document.getElementById('btn-login').addEventListener('click', async () => {
  await supabase.auth.signInWithOAuth({
    provider: 'github',
    options: { redirectTo: window.location.origin + '/invitation-codes' }
  });
});
document.getElementById('btn-logout').addEventListener('click', async () => {
  await supabase.auth.signOut();
  setUser(null);
});

// Load user-submitted apps from Supabase and merge with seed apps
async function loadApps() {
  const { data } = await supabase.from('apps').select('*').order('created_at', { ascending: true });
  const grid = document.getElementById('app-grid');
  (data || []).forEach(app => {
    if (grid.querySelector(`[data-slug="${CSS.escape(app.slug)}"]`)) return;
    const btn = document.createElement('button');
    btn.className = 'app-card';
    btn.dataset.slug = app.slug;
    btn.dataset.category = app.category;
    btn.dataset.website = app.website;
    const favicon = new URL('/favicon.ico', app.website).href;
    btn.innerHTML = `
      <img src="${escapeHtml(favicon)}" alt="${escapeHtml(app.name)}" class="app-icon" width="40" height="40" loading="lazy" />
      <span class="app-name">${escapeHtml(app.name)}</span>
      <span class="code-count" data-count-for="${escapeHtml(app.slug)}">-</span>`;
    grid.appendChild(btn);
  });
}

async function fetchCounts() {
  const { data } = await supabase.from('codes').select('app_slug');
  const counts = {};
  (data || []).forEach(r => { counts[r.app_slug] = (counts[r.app_slug] || 0) + 1; });
  document.querySelectorAll('[data-count-for]').forEach(el => {
    el.textContent = counts[el.dataset.countFor] || 0;
  });
}

// Category tabs
document.getElementById('category-tabs').addEventListener('click', (e) => {
  const btn = e.target.closest('.tab');
  if (!btn) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  const cat = btn.dataset.category;
  document.querySelectorAll('.app-card').forEach(card => {
    card.classList.toggle('hidden', cat !== 'all' && card.dataset.category !== cat);
  });
});

// App card click
document.getElementById('app-grid').addEventListener('click', (e) => {
  const card = e.target.closest('.app-card');
  if (!card) return;
  const slug = card.dataset.slug;
  document.querySelectorAll('.app-card').forEach(c => c.classList.remove('active'));
  card.classList.add('active');
  selectedApp = slug;
  const panel = document.getElementById('code-panel');
  panel.style.display = 'block';
  document.getElementById('panel-app-name').textContent = card.querySelector('.app-name').textContent;
  document.getElementById('panel-app-link').href = card.dataset.website || '#';
  if (!currentUser) {
    document.getElementById('submit-form').style.display = 'none';
    document.getElementById('login-hint').style.display = 'block';
  } else {
    document.getElementById('submit-form').style.display = 'flex';
    document.getElementById('login-hint').style.display = 'none';
  }
  loadCodes(slug);
});

// Add app form
document.getElementById('btn-add-app').addEventListener('click', () => {
  document.getElementById('btn-add-app').style.display = 'none';
  document.getElementById('add-app-form').style.display = 'flex';
});
document.getElementById('btn-add-app-cancel').addEventListener('click', () => {
  document.getElementById('add-app-form').style.display = 'none';
  document.getElementById('btn-add-app').style.display = 'block';
});
document.getElementById('btn-add-app-submit').addEventListener('click', async () => {
  const name = document.getElementById('app-name-input').value.trim();
  const website = document.getElementById('app-website-input').value.trim();
  const category = document.getElementById('app-category-input').value;
  if (!name || !website || !currentUser) return;
  const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  const meta = currentUser.user_metadata;
  const username = meta.user_name || meta.preferred_username || 'unknown';
  const { error } = await supabase.from('apps').insert({
    slug, name, website, category,
    submitted_by: currentUser.id,
    github_username: username
  });
  if (!error) {
    document.getElementById('app-name-input').value = '';
    document.getElementById('app-website-input').value = '';
    document.getElementById('add-app-form').style.display = 'none';
    document.getElementById('btn-add-app').style.display = 'block';
    await loadApps();
    fetchCounts();
  }
});

async function loadCodes(slug) {
  const list = document.getElementById('code-list');
  list.innerHTML = '<p class="empty-msg">Loading...</p>';
  const { data, error } = await supabase
    .from('codes').select('*')
    .eq('app_slug', slug)
    .order('created_at', { ascending: false });
  if (error || !data?.length) {
    list.innerHTML = `<p class="empty-msg">${escapeHtml(t('noCodes'))}</p>`;
    return;
  }
  list.innerHTML = data.map(code => `
    <div class="code-item">
      <span class="code-text">${currentUser ? escapeHtml(code.code) : '••••••••'}</span>
      <span class="code-meta">
        @${escapeHtml(code.github_username)} · ${timeAgo(code.created_at)}
        ${currentUser ? `<button class="btn-copy" data-code="${escapeHtml(code.code)}" data-id="${code.id}" title="${t('copy')}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>` : ''}
        ${currentUser && code.submitted_by === currentUser.id
          ? `<button class="btn-delete" data-id="${code.id}" title="${t('delete')}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>` : ''}
      </span>
    </div>`).join('');
}

document.getElementById('code-list').addEventListener('click', async (e) => {
  const copyBtn = e.target.closest('.btn-copy');
  if (copyBtn) {
    const code = copyBtn.dataset.code;
    try { await navigator.clipboard.writeText(code); }
    catch {
      const ta = document.createElement('textarea');
      ta.value = code; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
    }
    copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>';
    // Claim the code so others won't see it
    if (currentUser) {
      await supabase.from('codes').update({ status: 'claimed' })
        .eq('id', copyBtn.dataset.id).eq('status', 'active');
      loadCodes(selectedApp);
      fetchCounts();
    }
    return;
  }
  const delBtn = e.target.closest('.btn-delete');
  if (delBtn) {
    await supabase.from('codes').delete().eq('id', delBtn.dataset.id);
    loadCodes(selectedApp);
    fetchCounts();
  }
});

document.getElementById('btn-submit').addEventListener('click', async () => {
  const input = document.getElementById('code-input');
  const code = input.value.trim();
  if (!code || !selectedApp || !currentUser) return;
  const meta = currentUser.user_metadata;
  const username = meta.user_name || meta.preferred_username || 'unknown';
  const { error } = await supabase.from('codes').insert({
    app_slug: selectedApp, code,
    submitted_by: currentUser.id,
    github_username: username
  });
  if (!error) {
    input.value = '';
    loadCodes(selectedApp);
    fetchCounts();
  }
});

document.getElementById('code-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('btn-submit').click();
});

// Init
applyI18n();
await loadApps();
fetchCounts();
</script>
