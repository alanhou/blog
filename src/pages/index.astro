---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { seriesNames } from '../config/series';

const posts = await getCollection('blog');
const recentPosts = posts
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 12);

// Build series data: group posts by series, count them, find first post
const seriesMap = new Map<string, typeof posts>();
for (const post of posts) {
  if (post.data.series) {
    const arr = seriesMap.get(post.data.series) || [];
    arr.push(post);
    seriesMap.set(post.data.series, arr);
  }
}

const seriesData = Array.from(seriesMap.entries())
  .map(([key, seriesPosts]) => {
    const sorted = seriesPosts.sort((a, b) => (a.data.seriesOrder || 0) - (b.data.seriesOrder || 0));
    const name = seriesNames[key] || { en: key, zh: key };
    return {
      key,
      name,
      count: seriesPosts.length,
      firstPost: sorted[0],
    };
  })
  .sort((a, b) => b.count - a.count);
---
<Layout title="Home / È¶ñÈ°µ">

  <section class="recent-posts">
    <h2>Recent Posts</h2>
    <div class="posts-grid">
      {recentPosts.map(post => (
        <a href={`/blog/${post.slug}/`} class="post-card">
          {post.data.image && (
            <img src={post.data.image} alt="" class="post-image" loading="lazy" />
          )}
          <div class="post-content">
            <div class="post-titles">
              <h3>{post.data.title.en}</h3>
              <p class="post-title-zh">{post.data.title.zh}</p>
            </div>
            <div class="post-meta">
              <time>{post.data.date.toLocaleDateString()}</time>
              {post.data.tags && (
                <div class="tags">
                  {post.data.tags.slice(0, 3).map(tag => (
                    <span class="tag">{tag}</span>
                  ))}
                </div>
              )}
            </div>
          </div>
        </a>
      ))}
    </div>
    <a href="/blog" class="view-all">View all posts ‚Üí</a>
  </section>

  <section class="series-section">
    <h2>Series</h2>
    <div class="series-grid">
      {seriesData.map(s => (
        <a href={`/blog/${s.firstPost.slug}/`} class="series-card">
          <h3>{s.name.en}</h3>
          <p class="series-name-zh">{s.name.zh}</p>
          <span class="series-count">{s.count} posts</span>
        </a>
      ))}
    </div>
  </section>

  <section class="quick-links">
    <a href="/prompts" class="quick-link">
      <span class="icon">üìù</span>
      <span>Prompts</span>
    </a>
    <a href="/tools" class="quick-link">
      <span class="icon">üõ†Ô∏è</span>
      <span>Tools</span>
    </a>
    <a href="/about" class="quick-link">
      <span class="icon">üë§</span>
      <span>About</span>
    </a>
  </section>
</Layout>

<style>
.hero {
  text-align: center;
  padding: 2rem 0 1.5rem;
}
.hero h1 {
  font-size: 2rem;
  margin-bottom: 0.25rem;
}

.recent-posts {
  padding: 2rem 0;
}
.recent-posts h2 {
  margin-bottom: 1.5rem;
}
.posts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}
.post-card {
  display: flex;
  flex-direction: column;
  background: var(--bg-secondary);
  border-radius: 8px;
  overflow: hidden;
  text-decoration: none;
  color: inherit;
  transition: transform 0.2s, box-shadow 0.2s;
}
.post-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.post-image {
  width: 100%;
  height: 160px;
  object-fit: cover;
}
.post-content {
  padding: 1rem;
  display: flex;
  flex-direction: column;
  flex: 1;
}
.post-titles {
  flex: 1;
}
.post-content h3 {
  font-size: 1.1rem;
  margin-bottom: 0.25rem;
  color: var(--text);
}
.post-title-zh {
  font-size: 0.95rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}
.post-meta {
  margin-top: auto;
  padding-top: 0.75rem;
  border-top: 1px solid var(--border);
}
.post-content time {
  font-size: 0.85rem;
  color: var(--text-secondary);
}
.tags {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
  flex-wrap: wrap;
}
.tag {
  font-size: 0.75rem;
  padding: 0.2rem 0.5rem;
  background: var(--primary);
  color: white;
  border-radius: 4px;
}
.view-all {
  display: inline-block;
  color: var(--primary);
  font-weight: 500;
}

.quick-links {
  display: flex;
  gap: 1rem;
  justify-content: center;
  padding: 2rem 0 4rem;
  flex-wrap: wrap;
}
.quick-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem 1.5rem;
  background: var(--bg-secondary);
  border-radius: 8px;
  text-decoration: none;
  color: var(--text);
  transition: background 0.2s;
}
.quick-link:hover {
  background: var(--primary);
  color: white;
}
.quick-link .icon {
  font-size: 1.2rem;
}

.series-section {
  padding: 2rem 0;
}
.series-section h2 {
  margin-bottom: 1.5rem;
}
.series-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
}
.series-card {
  display: flex;
  flex-direction: column;
  padding: 1.25rem;
  background: var(--bg-secondary);
  border-radius: 8px;
  text-decoration: none;
  color: inherit;
  border: 1px solid var(--border);
  transition: transform 0.2s, border-color 0.2s;
}
.series-card:hover {
  transform: translateY(-2px);
  border-color: var(--primary);
}
.series-card h3 {
  font-size: 1rem;
  margin-bottom: 0.25rem;
  color: var(--text);
}
.series-name-zh {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 0.75rem;
}
.series-count {
  margin-top: auto;
  font-size: 0.8rem;
  color: var(--text-muted);
}

@media (max-width: 768px) {
  .hero h1 {
    font-size: 1.75rem;
  }
  .tagline {
    font-size: 1rem;
  }
  .posts-grid {
    grid-template-columns: 1fr;
  }
}
</style>
