---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="JSON Parser & Viewer / JSON解析查看器">
  <div class="tool-page">
    <h1>JSON Parser & Viewer</h1>
    <p class="subtitle">Parse, format, and view JSON data / 解析、格式化和查看JSON数据</p>

    <div class="tool-container">
      <div class="panels">
        <div class="editor-area">
          <div class="editor-header">
            <span>Input</span>
            <div class="editor-actions">
              <button id="paste-btn" title="Paste from clipboard">Paste</button>
              <button id="clear-btn" title="Clear input">Clear</button>
            </div>
          </div>
          <textarea id="json-input" spellcheck="false" placeholder='Paste or type JSON here...\n{"key": "value"}'></textarea>
          <div class="btn-row">
            <button id="format-btn" class="primary-btn">Format / 格式化</button>
            <button id="minify-btn" class="secondary-btn">Minify / 压缩</button>
          </div>
          <div id="error-msg" class="error-msg" hidden></div>
        </div>

        <div class="editor-area">
          <div class="editor-header">
            <span>Output</span>
            <button id="copy-btn" title="Copy to clipboard">Copy</button>
          </div>
          <div id="json-output" class="json-output"></div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
.tool-page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 0;
}
.subtitle {
  color: var(--text-secondary);
  margin-bottom: 2rem;
}

.tool-container {
  background: var(--bg-secondary);
  padding: 2rem;
  border-radius: 12px;
}

.panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

.editor-area {
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.editor-actions {
  display: flex;
  gap: 0.5rem;
}

.editor-header button {
  padding: 0.25rem 0.75rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  color: var(--text);
  font-size: 0.85rem;
  transition: background 0.2s;
}

.editor-header button:hover {
  background: var(--border);
}

#json-input {
  width: 100%;
  min-height: 400px;
  padding: 1rem;
  font-family: monospace;
  font-size: 0.9rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  resize: vertical;
  tab-size: 2;
  white-space: pre;
  overflow-wrap: normal;
  overflow-x: auto;
  box-sizing: border-box;
  flex: 1;
}

.btn-row {
  display: flex;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.primary-btn, .secondary-btn {
  flex: 1;
  padding: 0.75rem;
  font-size: 1rem;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.primary-btn {
  background: var(--primary);
  color: white;
}

.secondary-btn {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
}

.primary-btn:hover, .secondary-btn:hover {
  opacity: 0.9;
}

.error-msg {
  padding: 0.75rem 1rem;
  background: #ef44441a;
  color: #ef4444;
  border-radius: 8px;
  font-family: monospace;
  font-size: 0.85rem;
  margin-top: 0.75rem;
}

.json-output {
  width: 100%;
  min-height: 400px;
  max-height: 600px;
  overflow: auto;
  padding: 1rem;
  font-family: monospace;
  font-size: 0.9rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  box-sizing: border-box;
  flex: 1;
  line-height: 1.5;
}

@media (max-width: 768px) {
  .panels {
    grid-template-columns: 1fr;
  }
  #json-input, .json-output {
    min-height: 200px;
  }
}
</style>

<style is:global>
.json-key { color: #e06c75; }
.json-string { color: #98c379; }
.json-number { color: #d19a66; }
.json-boolean { color: #56b6c2; }
.json-null { color: #848b98; }

.tree-node {
  display: inline;
}

.collapsible {
  cursor: pointer;
  user-select: none;
}

.collapsible::before {
  content: '▼ ';
  font-size: 0.7em;
  display: inline-block;
  transition: transform 0.15s;
}

.collapsible.collapsed::before {
  transform: rotate(-90deg);
}

.collapsible.collapsed::after {
  content: ' /* ' attr(data-summary) ' */ ';
  color: var(--text-secondary);
  font-style: italic;
  font-size: 0.85em;
}

.collapsible.collapsed ~ .block-content {
  display: none;
}

.collapsible.collapsed ~ .block-close {
  display: none;
}

.block-content {
  padding-left: 1.25rem;
}

.block-close {
  display: block;
}

.tree-line {
  line-height: 1.6;
}
</style>

<script>
const input = document.getElementById('json-input') as HTMLTextAreaElement;
const output = document.getElementById('json-output')!;
const errorMsg = document.getElementById('error-msg')!;
const formatBtn = document.getElementById('format-btn')!;
const minifyBtn = document.getElementById('minify-btn')!;
const copyBtn = document.getElementById('copy-btn')!;
const pasteBtn = document.getElementById('paste-btn')!;
const clearBtn = document.getElementById('clear-btn')!;

let lastParsed: any = null;
let lastMinify = false;

function escapeHtml(s: string): string {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function colorize(val: any): string {
  if (val === null) return '<span class="json-null">null</span>';
  if (typeof val === 'boolean') return `<span class="json-boolean">${val}</span>`;
  if (typeof val === 'number') return `<span class="json-number">${val}</span>`;
  if (typeof val === 'string') return `<span class="json-string">"${escapeHtml(val)}"</span>`;
  return '';
}

function renderTree(data: any): string {
  if (data === null || typeof data !== 'object') return colorize(data);

  const isArray = Array.isArray(data);
  const entries = isArray ? data.map((v: any, i: number) => [i, v]) : Object.entries(data);
  const open = isArray ? '[' : '{';
  const close = isArray ? ']' : '}';
  const count = entries.length;

  if (count === 0) return `${open}${close}`;

  const summary = isArray ? `${count} items` : `${count} keys`;
  let html = `<div class="tree-node">`;
  html += `<span class="collapsible" data-summary="${summary}">${open}</span>`;
  html += `<div class="block-content">`;
  entries.forEach(([key, val]: [any, any], idx: number) => {
    const comma = idx < count - 1 ? ',' : '';
    const keyHtml = isArray ? '' : `<span class="json-key">"${escapeHtml(String(key))}"</span>: `;
    html += `<div class="tree-line">${keyHtml}${renderTree(val)}${comma}</div>`;
  });
  html += `</div>`;
  html += `<span class="block-close">${close}</span>`;
  html += `</div>`;
  return html;
}

function parseAndRender(minify = false) {
  errorMsg.hidden = true;
  const raw = input.value.trim();
  if (!raw) { output.innerHTML = ''; return; }
  try {
    const parsed = JSON.parse(raw);
    lastParsed = parsed;
    lastMinify = minify;
    if (minify) {
      output.textContent = JSON.stringify(parsed);
    } else {
      output.innerHTML = renderTree(parsed);
      // attach collapse listeners
      output.querySelectorAll('.collapsible').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          el.classList.toggle('collapsed');
        });
      });
    }
  } catch (e: any) {
    errorMsg.textContent = `Error: ${e.message}`;
    errorMsg.hidden = false;
    output.innerHTML = '';
  }
}

formatBtn.addEventListener('click', () => parseAndRender(false));
minifyBtn.addEventListener('click', () => parseAndRender(true));

copyBtn.addEventListener('click', async () => {
  if (lastParsed !== null) {
    const text = lastMinify ? JSON.stringify(lastParsed) : JSON.stringify(lastParsed, null, 2);
    await navigator.clipboard.writeText(text);
    copyBtn.textContent = 'Copied!';
    setTimeout(() => copyBtn.textContent = 'Copy', 1500);
  }
});

pasteBtn.addEventListener('click', async () => {
  input.value = await navigator.clipboard.readText();
});

clearBtn.addEventListener('click', () => {
  input.value = '';
  output.innerHTML = '';
  errorMsg.hidden = true;
});
</script>
