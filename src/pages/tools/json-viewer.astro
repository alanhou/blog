---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="JSON Parser & Viewer / JSON解析查看器">
  <div class="tool-page">
    <h1>JSON Parser & Viewer</h1>
    <p class="subtitle">Parse, format, and view JSON data / 解析、格式化和查看JSON数据</p>

    <div class="tool-container">
      <div class="editor-area">
        <div class="editor-header">
          <span>Input</span>
          <div class="editor-actions">
            <button id="paste-btn" title="Paste from clipboard">Paste</button>
            <button id="clear-btn" title="Clear input">Clear</button>
          </div>
        </div>
        <textarea id="json-input" spellcheck="false" placeholder='Paste or type JSON here...\n{"key": "value"}'></textarea>
      </div>

      <div class="btn-row">
        <button id="format-btn" class="primary-btn">Format / 格式化</button>
        <button id="minify-btn" class="secondary-btn">Minify / 压缩</button>
      </div>

      <div id="error-msg" class="error-msg" hidden></div>

      <div class="editor-area">
        <div class="editor-header">
          <span>Output</span>
          <button id="copy-btn" title="Copy to clipboard">Copy</button>
        </div>
        <pre id="json-output" class="json-output"></pre>
      </div>
    </div>
  </div>
</Layout>

<style>
.tool-page {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem 0;
}
.subtitle {
  color: var(--text-secondary);
  margin-bottom: 2rem;
}

.tool-container {
  background: var(--bg-secondary);
  padding: 2rem;
  border-radius: 12px;
}

.editor-area {
  margin-bottom: 1rem;
}

.editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.editor-actions {
  display: flex;
  gap: 0.5rem;
}

.editor-header button {
  padding: 0.25rem 0.75rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  color: var(--text);
  font-size: 0.85rem;
  transition: background 0.2s;
}

.editor-header button:hover {
  background: var(--border);
}

#json-input {
  width: 100%;
  min-height: 180px;
  padding: 1rem;
  font-family: monospace;
  font-size: 0.9rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  resize: vertical;
  tab-size: 2;
  box-sizing: border-box;
}

.btn-row {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.primary-btn, .secondary-btn {
  flex: 1;
  padding: 0.75rem;
  font-size: 1rem;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.primary-btn {
  background: var(--primary);
  color: white;
}

.secondary-btn {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
}

.primary-btn:hover, .secondary-btn:hover {
  opacity: 0.9;
}

.error-msg {
  padding: 0.75rem 1rem;
  background: #ef44441a;
  color: #ef4444;
  border-radius: 8px;
  font-family: monospace;
  font-size: 0.85rem;
  margin-bottom: 1rem;
}

.json-output {
  width: 100%;
  min-height: 180px;
  max-height: 500px;
  overflow: auto;
  padding: 1rem;
  font-family: monospace;
  font-size: 0.9rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  white-space: pre-wrap;
  word-break: break-word;
  box-sizing: border-box;
}

.json-key { color: #e06c75; }
.json-string { color: #98c379; }
.json-number { color: #d19a66; }
.json-boolean { color: #56b6c2; }
.json-null { color: #848b98; }
</style>

<script>
const input = document.getElementById('json-input') as HTMLTextAreaElement;
const output = document.getElementById('json-output')!;
const errorMsg = document.getElementById('error-msg')!;
const formatBtn = document.getElementById('format-btn')!;
const minifyBtn = document.getElementById('minify-btn')!;
const copyBtn = document.getElementById('copy-btn')!;
const pasteBtn = document.getElementById('paste-btn')!;
const clearBtn = document.getElementById('clear-btn')!;

function syntaxHighlight(json: string): string {
  return json.replace(/("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
    (match) => {
      let cls = 'json-number';
      if (/^"/.test(match)) {
        cls = /:$/.test(match) ? 'json-key' : 'json-string';
      } else if (/true|false/.test(match)) {
        cls = 'json-boolean';
      } else if (/null/.test(match)) {
        cls = 'json-null';
      }
      return `<span class="${cls}">${match}</span>`;
    });
}

function parseAndFormat(minify = false) {
  errorMsg.hidden = true;
  const raw = input.value.trim();
  if (!raw) {
    output.innerHTML = '';
    return;
  }
  try {
    const parsed = JSON.parse(raw);
    const formatted = minify ? JSON.stringify(parsed) : JSON.stringify(parsed, null, 2);
    if (minify) {
      output.textContent = formatted;
      input.value = formatted;
    } else {
      output.innerHTML = syntaxHighlight(formatted);
      input.value = formatted;
    }
  } catch (e: any) {
    errorMsg.textContent = `Error: ${e.message}`;
    errorMsg.hidden = false;
    output.innerHTML = '';
  }
}

formatBtn.addEventListener('click', () => parseAndFormat(false));
minifyBtn.addEventListener('click', () => parseAndFormat(true));

copyBtn.addEventListener('click', async () => {
  const text = output.textContent;
  if (text) {
    await navigator.clipboard.writeText(text);
    copyBtn.textContent = 'Copied!';
    setTimeout(() => copyBtn.textContent = 'Copy', 1500);
  }
});

pasteBtn.addEventListener('click', async () => {
  input.value = await navigator.clipboard.readText();
});

clearBtn.addEventListener('click', () => {
  input.value = '';
  output.innerHTML = '';
  errorMsg.hidden = true;
});
</script>
