---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="QR Code Generator">
  <div class="tool-page">
    <h1>QR Code Generator</h1>
    <p class="subtitle">Generate QR codes from URLs or text / 从URL或文本生成二维码</p>

    <div class="tool-container">
      <div class="input-section">
        <label for="input-text">URL or Text:</label>
        <input type="text" id="input-text" placeholder="https://example.com or any text">
      </div>

      <div class="options">
        <div class="option">
          <label for="size">Size: <span id="size-value">256</span>px</label>
          <input type="range" id="size" min="128" max="512" value="256" step="32">
        </div>

        <div class="option">
          <label for="error-correction">Error Correction:</label>
          <select id="error-correction">
            <option value="L">Low (7%)</option>
            <option value="M" selected>Medium (15%)</option>
            <option value="Q">Quartile (25%)</option>
            <option value="H">High (30%)</option>
          </select>
        </div>

        <div class="color-options">
          <div class="option">
            <label for="fg-color">Foreground:</label>
            <input type="color" id="fg-color" value="#000000">
          </div>
          <div class="option">
            <label for="bg-color">Background:</label>
            <input type="color" id="bg-color" value="#ffffff">
          </div>
        </div>
      </div>

      <button id="generate-btn" class="primary-btn">Generate QR Code</button>

      <div id="output-section" class="output-section hidden">
        <div class="qr-preview">
          <canvas id="qr-canvas"></canvas>
        </div>
        <div class="actions">
          <button id="download-png">Download PNG</button>
          <button id="download-svg">Download SVG</button>
          <button id="copy-image">Copy to Clipboard</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
.tool-page {
  max-width: 600px;
  margin: 0 auto;
  padding: 2rem 0;
}

.subtitle {
  color: var(--text-secondary);
  margin-bottom: 2rem;
}

.tool-container {
  background: var(--bg-secondary);
  padding: 2rem;
  border-radius: 12px;
}

.input-section {
  margin-bottom: 1.5rem;
}

.input-section label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.input-section input {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
}

.options {
  margin-bottom: 1.5rem;
}

.option {
  margin-bottom: 1rem;
}

.option label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.option input[type="range"] {
  width: 100%;
  cursor: pointer;
}

.option select {
  width: 100%;
  padding: 0.75rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  cursor: pointer;
}

.color-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.color-options input[type="color"] {
  width: 100%;
  height: 40px;
  padding: 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
}

.primary-btn {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
  font-weight: 600;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.primary-btn:hover {
  opacity: 0.9;
}

.output-section {
  margin-top: 2rem;
  text-align: center;
}

.qr-preview {
  display: flex;
  justify-content: center;
  margin-bottom: 1.5rem;
}

.qr-preview canvas {
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.actions {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
}

.actions button {
  padding: 0.5rem 1rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  color: var(--text);
  font-size: 0.9rem;
  transition: background 0.2s;
}

.actions button:hover {
  background: var(--border);
}

.hidden {
  display: none !important;
}

@media (max-width: 480px) {
  .color-options {
    grid-template-columns: 1fr;
  }

  .actions {
    flex-direction: column;
  }

  .actions button {
    width: 100%;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
declare const QRCode: any;

const inputText = document.getElementById('input-text') as HTMLInputElement;
const sizeSlider = document.getElementById('size') as HTMLInputElement;
const sizeValue = document.getElementById('size-value')!;
const errorCorrection = document.getElementById('error-correction') as HTMLSelectElement;
const fgColor = document.getElementById('fg-color') as HTMLInputElement;
const bgColor = document.getElementById('bg-color') as HTMLInputElement;
const generateBtn = document.getElementById('generate-btn')!;
const outputSection = document.getElementById('output-section')!;
const qrCanvas = document.getElementById('qr-canvas') as HTMLCanvasElement;

sizeSlider.addEventListener('input', () => {
  sizeValue.textContent = sizeSlider.value;
});

async function generateQR() {
  const text = inputText.value.trim();
  if (!text) {
    alert('Please enter a URL or text');
    return;
  }

  const size = parseInt(sizeSlider.value);
  const options = {
    width: size,
    margin: 2,
    errorCorrectionLevel: errorCorrection.value,
    color: {
      dark: fgColor.value,
      light: bgColor.value
    }
  };

  try {
    await QRCode.toCanvas(qrCanvas, text, options);
    outputSection.classList.remove('hidden');
  } catch (err) {
    alert('Error generating QR code: ' + (err as Error).message);
  }
}

generateBtn.addEventListener('click', generateQR);

inputText.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') generateQR();
});

document.getElementById('download-png')?.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'qrcode.png';
  link.href = qrCanvas.toDataURL('image/png');
  link.click();
});

document.getElementById('download-svg')?.addEventListener('click', async () => {
  const text = inputText.value.trim();
  if (!text) return;

  const svgString = await QRCode.toString(text, {
    type: 'svg',
    width: parseInt(sizeSlider.value),
    margin: 2,
    errorCorrectionLevel: errorCorrection.value,
    color: {
      dark: fgColor.value,
      light: bgColor.value
    }
  });

  const blob = new Blob([svgString], { type: 'image/svg+xml' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.download = 'qrcode.svg';
  link.href = url;
  link.click();
  URL.revokeObjectURL(url);
});

document.getElementById('copy-image')?.addEventListener('click', async () => {
  try {
    const blob = await new Promise<Blob>((resolve) => {
      qrCanvas.toBlob((b) => resolve(b!), 'image/png');
    });
    await navigator.clipboard.write([
      new ClipboardItem({ 'image/png': blob })
    ]);
    const btn = document.getElementById('copy-image')!;
    const original = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = original, 1500);
  } catch (err) {
    alert('Failed to copy: ' + (err as Error).message);
  }
});
</script>
</Layout>
