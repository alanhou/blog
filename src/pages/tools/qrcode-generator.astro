---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="QR Code Generator">
  <div class="tool-page">
    <h1>QR Code Generator</h1>
    <p class="subtitle">Generate QR codes from URLs or text / 从URL或文本生成二维码</p>

    <div class="tool-container">
      <div class="input-section">
        <label for="input-text">URL or Text:</label>
        <input type="text" id="input-text" placeholder="https://example.com or any text">
      </div>

      <div class="options">
        <div class="option">
          <label for="size">Size: <span id="size-value">256</span>px</label>
          <input type="range" id="size" min="128" max="512" value="256" step="32">
        </div>

        <div class="option">
          <label for="error-correction">Error Correction:</label>
          <select id="error-correction">
            <option value="L">Low (7%)</option>
            <option value="M" selected>Medium (15%)</option>
            <option value="Q">Quartile (25%)</option>
            <option value="H">High (30%)</option>
          </select>
        </div>

        <div class="color-options">
          <div class="option">
            <label for="fg-color">Foreground:</label>
            <input type="color" id="fg-color" value="#000000">
          </div>
          <div class="option">
            <label for="bg-color">Background:</label>
            <input type="color" id="bg-color" value="#ffffff">
          </div>
        </div>
      </div>

      <button id="generate-btn" class="primary-btn">Generate QR Code</button>

      <div id="output-section" class="output-section hidden">
        <div class="qr-preview">
          <canvas id="qr-canvas"></canvas>
        </div>
        <div class="actions">
          <button id="download-png">Download PNG</button>
          <button id="download-svg">Download SVG</button>
          <button id="copy-image">Copy to Clipboard</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
.tool-page {
  max-width: 600px;
  margin: 0 auto;
  padding: 2rem 0;
}

.subtitle {
  color: var(--text-secondary);
  margin-bottom: 2rem;
}

.tool-container {
  background: var(--bg-secondary);
  padding: 2rem;
  border-radius: 12px;
}

.input-section {
  margin-bottom: 1.5rem;
}

.input-section label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.input-section input {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
}

.options {
  margin-bottom: 1.5rem;
}

.option {
  margin-bottom: 1rem;
}

.option label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.option input[type="range"] {
  width: 100%;
  cursor: pointer;
}

.option select {
  width: 100%;
  padding: 0.75rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  cursor: pointer;
}

.color-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.color-options input[type="color"] {
  width: 100%;
  height: 40px;
  padding: 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
}

.primary-btn {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
  font-weight: 600;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.primary-btn:hover {
  opacity: 0.9;
}

.output-section {
  margin-top: 2rem;
  text-align: center;
}

.qr-preview {
  display: flex;
  justify-content: center;
  margin-bottom: 1.5rem;
}

.qr-preview canvas {
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.actions {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
}

.actions button {
  padding: 0.5rem 1rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  color: var(--text);
  font-size: 0.9rem;
  transition: background 0.2s;
}

.actions button:hover {
  background: var(--border);
}

.hidden {
  display: none !important;
}

@media (max-width: 480px) {
  .color-options {
    grid-template-columns: 1fr;
  }

  .actions {
    flex-direction: column;
  }

  .actions button {
    width: 100%;
  }
}
</style>

<script is:inline src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script is:inline>
window.addEventListener('DOMContentLoaded', function() {
  var inputText = document.getElementById('input-text');
  var sizeSlider = document.getElementById('size');
  var sizeValue = document.getElementById('size-value');
  var errorCorrection = document.getElementById('error-correction');
  var fgColor = document.getElementById('fg-color');
  var bgColor = document.getElementById('bg-color');
  var generateBtn = document.getElementById('generate-btn');
  var outputSection = document.getElementById('output-section');
  var qrCanvas = document.getElementById('qr-canvas');

  sizeSlider.addEventListener('input', function() {
    sizeValue.textContent = sizeSlider.value;
  });

  function generateQR() {
    var text = inputText.value.trim();
    if (!text) {
      alert('Please enter a URL or text');
      return;
    }

    var size = parseInt(sizeSlider.value);
    var options = {
      width: size,
      margin: 2,
      errorCorrectionLevel: errorCorrection.value,
      color: {
        dark: fgColor.value,
        light: bgColor.value
      }
    };

    QRCode.toCanvas(qrCanvas, text, options, function(err) {
      if (err) {
        alert('Error generating QR code: ' + err.message);
        return;
      }
      outputSection.classList.remove('hidden');
    });
  }

  generateBtn.addEventListener('click', generateQR);

  inputText.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') generateQR();
  });

  document.getElementById('download-png').addEventListener('click', function() {
    var link = document.createElement('a');
    link.download = 'qrcode.png';
    link.href = qrCanvas.toDataURL('image/png');
    link.click();
  });

  document.getElementById('download-svg').addEventListener('click', function() {
    var text = inputText.value.trim();
    if (!text) return;

    QRCode.toString(text, {
      type: 'svg',
      width: parseInt(sizeSlider.value),
      margin: 2,
      errorCorrectionLevel: errorCorrection.value,
      color: {
        dark: fgColor.value,
        light: bgColor.value
      }
    }, function(err, svgString) {
      if (err) return;
      var blob = new Blob([svgString], { type: 'image/svg+xml' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.download = 'qrcode.svg';
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
    });
  });

  document.getElementById('copy-image').addEventListener('click', function() {
    qrCanvas.toBlob(function(blob) {
      navigator.clipboard.write([
        new ClipboardItem({ 'image/png': blob })
      ]).then(function() {
        var btn = document.getElementById('copy-image');
        var original = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = original; }, 1500);
      }).catch(function(err) {
        alert('Failed to copy: ' + err.message);
      });
    }, 'image/png');
  });
});
</script>
</Layout>
