---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Base64 Image Encoder/Decoder / Base64图片编解码">
  <div class="tool-page">
    <h1>Base64 Image Encoder/Decoder</h1>
    <p class="subtitle">Convert images to/from Base64 / 图片与Base64互转</p>

    <div class="tabs">
      <button class="tab active" data-tab="encode">Encode (Image to Base64)</button>
      <button class="tab" data-tab="decode">Decode (Base64 to Image)</button>
    </div>

    <div class="tool-container">
      <!-- Encode Section -->
      <div id="encode-section" class="section active">
        <div class="drop-zone" id="drop-zone">
          <input type="file" id="file-input" accept="image/*" hidden>
          <p>Drop image here or <button id="browse-btn">browse</button></p>
          <p class="hint">Supports PNG, JPG, GIF, WebP, SVG</p>
        </div>

        <div id="encode-preview" class="preview hidden">
          <img id="preview-img" alt="Preview">
          <div class="file-info">
            <span id="file-name"></span>
            <span id="file-size"></span>
          </div>
        </div>

        <div id="encode-output" class="output-section hidden">
          <label>Base64 Output:</label>
          <textarea id="base64-output" readonly rows="6"></textarea>
          <div class="actions">
            <button id="copy-base64">Copy Base64</button>
            <button id="copy-dataurl">Copy Data URL</button>
            <button id="download-txt">Download .txt</button>
          </div>
        </div>
      </div>

      <!-- Decode Section -->
      <div id="decode-section" class="section">
        <label>Paste Base64 or Data URL:</label>
        <textarea id="base64-input" rows="6" placeholder="Paste base64 string or data:image/... URL here"></textarea>
        <button id="decode-btn" class="primary-btn">Decode Image</button>

        <div id="decode-output" class="hidden">
          <div class="decoded-preview">
            <img id="decoded-img" alt="Decoded image">
          </div>
          <div class="actions">
            <button id="download-img">Download Image</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
.tool-page {
  max-width: 700px;
  margin: 0 auto;
  padding: 2rem 0;
}

.subtitle {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}

.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.tab {
  flex: 1;
  padding: 0.75rem 1rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  color: var(--text-secondary);
  font-weight: 500;
  transition: all 0.2s;
}

.tab.active {
  background: var(--bg-secondary);
  border-bottom-color: var(--bg-secondary);
  color: var(--primary);
}

.tool-container {
  background: var(--bg-secondary);
  padding: 2rem;
  border-radius: 0 0 12px 12px;
  border: 1px solid var(--border);
  border-top: none;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

.drop-zone {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 3rem 2rem;
  text-align: center;
  transition: border-color 0.2s, background 0.2s;
}

.drop-zone.dragover {
  border-color: var(--primary);
  background: rgba(var(--primary-rgb), 0.05);
}

.drop-zone p {
  margin: 0.5rem 0;
  color: var(--text);
}

.drop-zone .hint {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

#browse-btn {
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  text-decoration: underline;
  font-size: inherit;
}

.preview {
  margin-top: 1.5rem;
  text-align: center;
}

.preview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.file-info {
  margin-top: 0.75rem;
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: flex;
  justify-content: center;
  gap: 1rem;
}

.output-section {
  margin-top: 1.5rem;
}

.output-section label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

textarea {
  width: 100%;
  padding: 1rem;
  font-family: monospace;
  font-size: 0.85rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  resize: vertical;
}

.actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.actions button {
  padding: 0.5rem 1rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  color: var(--text);
  font-size: 0.9rem;
  transition: background 0.2s;
}

.actions button:hover {
  background: var(--border);
}

.primary-btn {
  width: 100%;
  padding: 1rem;
  margin-top: 1rem;
  font-size: 1rem;
  font-weight: 600;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.primary-btn:hover {
  opacity: 0.9;
}

.decoded-preview {
  margin-top: 1.5rem;
  text-align: center;
}

.decoded-preview img {
  max-width: 100%;
  max-height: 400px;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.hidden {
  display: none !important;
}

#decode-section label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
}
</style>

<script>
// Tab switching
const tabs = document.querySelectorAll('.tab');
const sections = document.querySelectorAll('.section');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    sections.forEach(s => s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`${tab.dataset.tab}-section`)?.classList.add('active');
  });
});

// Encode functionality
const dropZone = document.getElementById('drop-zone')!;
const fileInput = document.getElementById('file-input') as HTMLInputElement;
const browseBtn = document.getElementById('browse-btn')!;
const encodePreview = document.getElementById('encode-preview')!;
const previewImg = document.getElementById('preview-img') as HTMLImageElement;
const fileName = document.getElementById('file-name')!;
const fileSize = document.getElementById('file-size')!;
const encodeOutput = document.getElementById('encode-output')!;
const base64Output = document.getElementById('base64-output') as HTMLTextAreaElement;

let currentDataUrl = '';

browseBtn.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  const file = e.dataTransfer?.files[0];
  if (file && file.type.startsWith('image/')) {
    processFile(file);
  }
});

fileInput.addEventListener('change', () => {
  const file = fileInput.files?.[0];
  if (file) processFile(file);
});

function processFile(file: File) {
  const reader = new FileReader();
  reader.onload = (e) => {
    currentDataUrl = e.target?.result as string;
    previewImg.src = currentDataUrl;
    fileName.textContent = file.name;
    fileSize.textContent = formatSize(file.size);

    // Extract base64 part (remove data:image/...;base64, prefix)
    const base64 = currentDataUrl.split(',')[1];
    base64Output.value = base64;

    encodePreview.classList.remove('hidden');
    encodeOutput.classList.remove('hidden');
  };
  reader.readAsDataURL(file);
}

function formatSize(bytes: number): string {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

document.getElementById('copy-base64')?.addEventListener('click', async () => {
  await navigator.clipboard.writeText(base64Output.value);
  showCopied('copy-base64');
});

document.getElementById('copy-dataurl')?.addEventListener('click', async () => {
  await navigator.clipboard.writeText(currentDataUrl);
  showCopied('copy-dataurl');
});

document.getElementById('download-txt')?.addEventListener('click', () => {
  const blob = new Blob([base64Output.value], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'base64.txt';
  a.click();
  URL.revokeObjectURL(url);
});

function showCopied(btnId: string) {
  const btn = document.getElementById(btnId)!;
  const original = btn.textContent;
  btn.textContent = 'Copied!';
  setTimeout(() => btn.textContent = original, 1500);
}

// Decode functionality
const base64Input = document.getElementById('base64-input') as HTMLTextAreaElement;
const decodeBtn = document.getElementById('decode-btn')!;
const decodeOutput = document.getElementById('decode-output')!;
const decodedImg = document.getElementById('decoded-img') as HTMLImageElement;

decodeBtn.addEventListener('click', () => {
  let input = base64Input.value.trim();
  if (!input) return;

  // If it's not a data URL, try to make it one
  if (!input.startsWith('data:')) {
    // Try to detect image type from base64 header
    let mimeType = 'image/png';
    if (input.startsWith('/9j/')) mimeType = 'image/jpeg';
    else if (input.startsWith('R0lGOD')) mimeType = 'image/gif';
    else if (input.startsWith('UklGR')) mimeType = 'image/webp';
    else if (input.startsWith('PHN2Zy')) mimeType = 'image/svg+xml';

    input = `data:${mimeType};base64,${input}`;
  }

  decodedImg.src = input;
  decodedImg.onload = () => {
    decodeOutput.classList.remove('hidden');
  };
  decodedImg.onerror = () => {
    alert('Invalid base64 image data');
    decodeOutput.classList.add('hidden');
  };
});

document.getElementById('download-img')?.addEventListener('click', () => {
  const a = document.createElement('a');
  a.href = decodedImg.src;
  // Extract extension from data URL
  const match = decodedImg.src.match(/data:image\/(\w+)/);
  const ext = match ? match[1].replace('jpeg', 'jpg') : 'png';
  a.download = `decoded-image.${ext}`;
  a.click();
});
</script>
